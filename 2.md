# ЛАБОРАТОРНАЯ РАБОТА №2
# ПОВЕДЕНИЕ СИСТЕМЫ РЕАЛЬНОГО ВРЕМЕНИ «КОФЕМАШИНА»

## Цель работы

Описание поведения системы реального времени «Кофемашина» с помощью диаграмм состояний и диаграмм активности. Определение операций классов системы.

---

## 1. Построение диаграммы состояний системы

Кофемашина представляет собой систему с множеством возможных состояний. При этом возможна вложенность состояний (подсостояния) и параллельность.

### 1.1. Основные состояния кофемашины

На первом этапе выделим основные состояния:

1. **Выключена** — машина обесточена
2. **Готова** — машина готова к приготовлению напитка
3. **Занята** — машина готовит напиток
4. **Ошибка** — произошла ошибка, требуется вмешательство

### 1.2. Условия состояния «Готова»

Кофемашина находится в состоянии «Готова», если выполняются все условия:
1. Машина включена
2. Достаточно воды в резервуаре
3. Достаточно зёрен в контейнере
4. Контейнер отходов не переполнен
5. Температура воды достигла рабочего значения (90-95°C)

### 1.3. Подсостояния состояния «Занята»

Состояние «Занята» имеет следующие последовательные подсостояния:

1. **Ожидание чашки** — ожидание установки чашки пользователем
2. **Помол** — кофемолка перемалывает зёрна
3. **Нагрев** — нагрев воды до рабочей температуры (если требуется)
4. **Пролив** — подача горячей воды через кофе
5. **Взбивание молока** — работа капучинатора (для капучино/латте)
6. **Завершение** — напиток готов

### 1.4. Ортогональные подсостояния

Следующие пары подсостояний ортогональны (независимы):
- **Нагрев** и **Помол** могут выполняться параллельно
- **Пролив** и **Взбивание** — последовательны (сначала кофе, потом молоко)

### Диаграмма состояний кофемашины

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ДИАГРАММА СОСТОЯНИЙ                                  │
│                         СИСТЕМЫ КОФЕМАШИНЫ                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────┐
                              │  (начало) │
                              └─────┬─────┘
                                    │
                                    ▼
                            ┌───────────────┐
                            │   ВЫКЛЮЧЕНА   │◄────────────────────────────┐
                            └───────┬───────┘                             │
                                    │ [нажата кнопка ВКЛ]                 │
                                    ▼                                     │
                            ┌───────────────┐                             │
                            │   ПРОГРЕВ     │                             │
                            │  (нагрев воды)│                             │
                            └───────┬───────┘                             │
                                    │ [температура >= 90°C]               │
                                    ▼                                     │
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐     │
    │    ОШИБКА     │◄──────│    ГОТОВА     │──────►│    ЗАНЯТА     │     │
    │               │ авария│               │выбран │               │     │
    │ - нет воды    │       │ Ожидание      │напиток│ Приготовление │     │
    │ - нет зёрен   │       │ выбора напитка│       │ напитка       │     │
    │ - перегрев    │       │               │       │               │     │
    │ - таймаут     │◄──────│               │◄──────│               │     │
    └───────┬───────┘ ошибка└───────────────┘готово └───────────────┘     │
            │                       │                                     │
            │ [устранена]           │ [нажата кнопка ВЫКЛ]                │
            └───────────────────────┴─────────────────────────────────────┘


                    ┌─────────────────────────────────────┐
                    │         ПОДСОСТОЯНИЯ "ЗАНЯТА"       │
                    └─────────────────────────────────────┘

        ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
        │  Ожидание    │────►│    Помол     │────►│   Нагрев     │
        │   чашки      │     │              │     │  (если нужен)│
        └──────────────┘     └──────────────┘     └──────┬───────┘
              │                                          │
              │ [чашка                                   │ [t >= 90°C]
              │  установлена]                            ▼
              │                                  ┌──────────────┐
              └─────────────────────────────────►│   Пролив     │
                                                 │              │
                                                 └──────┬───────┘
                                                        │
                          ┌─────────────────────────────┤
                          │                             │
                          ▼ [капучино/латте]            ▼ [эспрессо/американо]
                  ┌──────────────┐              ┌──────────────┐
                  │  Взбивание   │              │  Завершение  │
                  │   молока     │─────────────►│   (готово)   │
                  └──────────────┘              └──────────────┘
```

---

## 2. Построение диаграмм активности

Диаграммы активности описывают алгоритмы функционирования системы.

### 2.1. Диаграмма активности: приготовление эспрессо

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              ДИАГРАММА АКТИВНОСТИ: ПРИГОТОВЛЕНИЕ ЭСПРЕССО                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────┐
                              │  (начало) │
                              └─────┬─────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │ Нажата кнопка   │
                          │ "Эспрессо"      │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Подсветить      │
                          │ кнопку          │
                          └────────┬────────┘
                                   │
                                   ▼
                          ◇ Проверка ресурсов ◇
                         /                     \
                   [недост.]                 [OK]
                       │                        │
                       ▼                        ▼
              ┌─────────────────┐      ┌─────────────────┐
              │ Вывести ошибку  │      │ Проверить       │
              │ на дисплей      │      │ наличие чашки   │
              └────────┬────────┘      └────────┬────────┘
                       │                        │
                       ▼                        ▼
              ┌─────────────────┐         ◇ Чашка есть? ◇
              │ Погасить        │        /              \
              │ подсветку       │   [нет]              [да]
              └────────┬────────┘      │                 │
                       │               ▼                 │
                       │      ┌─────────────────┐        │
                       │      │ Вывести         │        │
                       │      │ "Установите     │        │
                       │      │  чашку"         │        │
                       │      └────────┬────────┘        │
                       │               │                 │
                       │               ▼                 │
                       │      ┌─────────────────┐        │
                       │      │ Ожидать чашку   │        │
                       │      │ (таймаут 30с)   │        │
                       │      └────────┬────────┘        │
                       │               │                 │
                       │               ▼                 │
                       │         ◇ Чашка? ◇              │
                       │        /         \              │
                       │   [таймаут]     [да]            │
                       │       │           │             │
                       │       │           └─────────────┤
                       │◄──────┘                         │
                       │                                 ▼
                       │                        ┌─────────────────┐
                       │                        │ Запустить       │
                       │                        │ кофемолку       │
                       │                        └────────┬────────┘
                       │                                 │
                       │                                 ▼
                       │                        ┌─────────────────┐
                       │                        │ Ожидать помол   │
                       │                        │ (7 секунд)      │
                       │                        └────────┬────────┘
                       │                                 │
                       │                                 ▼
                       │                        ┌─────────────────┐
                       │                        │ Остановить      │
                       │                        │ кофемолку       │
                       │                        └────────┬────────┘
                       │                                 │
                       │                                 ▼
                       │                          ◇ Темп. OK? ◇
                       │                         /            \
                       │                    [нет]            [да]
                       │                       │               │
                       │                       ▼               │
                       │              ┌─────────────────┐      │
                       │              │ Включить        │      │
                       │              │ нагреватель     │      │
                       │              └────────┬────────┘      │
                       │                       │               │
                       │                       ▼               │
                       │              ┌─────────────────┐      │
                       │              │ Ожидать нагрев  │      │
                       │              └────────┬────────┘      │
                       │                       │               │
                       │                       └───────────────┤
                       │                                       ▼
                       │                              ┌─────────────────┐
                       │                              │ Включить помпу  │
                       │                              └────────┬────────┘
                       │                                       │
                       │                                       ▼
                       │                              ┌─────────────────┐
                       │                              │ Пролив воды     │
                       │                              │ (25 секунд)     │
                       │                              └────────┬────────┘
                       │                                       │
                       │                                       ▼
                       │                              ┌─────────────────┐
                       │                              │ Выключить помпу │
                       │                              └────────┬────────┘
                       │                                       │
                       │                                       ▼
                       │                              ┌─────────────────┐
                       │                              │ Вывести         │
                       │                              │ "Готово!"       │
                       │                              └────────┬────────┘
                       │                                       │
                       │◄──────────────────────────────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ Погасить        │
              │ подсветку       │
              └────────┬────────┘
                       │
                       ▼
                  ┌─────────┐
                  │ (конец) │
                  └─────────┘
```

### 2.2. Диаграмма активности: приготовление капучино

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              ДИАГРАММА АКТИВНОСТИ: ПРИГОТОВЛЕНИЕ КАПУЧИНО                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────┐
                              │  (начало) │
                              └─────┬─────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │ Нажата кнопка   │
                          │ "Капучино"      │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Проверить       │
                          │ ресурсы         │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Ожидать/        │
                          │ проверить чашку │
                          └────────┬────────┘
                                   │
           ════════════════════════╪════════════════════════
           ║ ПАРАЛЛЕЛЬНОЕ         ║                        ║
           ║ ВЫПОЛНЕНИЕ           ▼                        ▼
           ║              ┌─────────────────┐    ┌─────────────────┐
           ║              │ Запустить       │    │ Проверить       │
           ║              │ кофемолку       │    │ температуру     │
           ║              └────────┬────────┘    └────────┬────────┘
           ║                       │                      │
           ║                       ▼                      ▼
           ║              ┌─────────────────┐    ┌─────────────────┐
           ║              │ Помол зёрен     │    │ Нагрев воды     │
           ║              │ (7 секунд)      │    │ (если нужно)    │
           ║              └────────┬────────┘    └────────┬────────┘
           ║                       │                      │
           ════════════════════════╪══════════════════════╪
                                   │                      │
                                   ▼                      │
                          ┌─────────────────┐             │
                          │ Синхронизация   │◄────────────┘
                          │ (ожидание)      │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Пролив эспрессо │
                          │ (25 секунд)     │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Включить        │
                          │ капучинатор     │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Взбить молоко   │
                          │ (15 секунд)     │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Выключить       │
                          │ капучинатор     │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ Вывести         │
                          │ "Капучино готов"│
                          └────────┬────────┘
                                   │
                                   ▼
                              ┌─────────┐
                              │ (конец) │
                              └─────────┘
```

---

## 3. Определение операций классов

Результаты описания поведения системы используются для определения операций классов.

### 3.1. Класс Кофемашина (CoffeeMachine)

```python
class DrinkType(Enum):
    NONE = 0
    ESPRESSO = 1
    AMERICANO = 2
    CAPPUCCINO = 3
    LATTE = 4
    HOT_WATER = 5

class MachineState(Enum):
    OFF = 0
    WARMING = 1
    READY = 2
    BUSY = 3
    ERROR = 4

class CoffeeMachine:
    # Атрибуты
    state: MachineState
    selected_drink: DrinkType
    progress: int  # 0-100%
    
    # Конструктор и деструктор
    def __init__(self): ...
    def __del__(self): ...
    
    # Операции управления питанием
    def power_on(self) -> bool: ...
    def power_off(self) -> None: ...
    
    # Операции выбора напитка
    def select_drink(self, drink: DrinkType) -> bool: ...
    def cancel(self) -> None: ...
    
    # Операции получения состояния
    def get_state(self) -> MachineState: ...
    def get_progress(self) -> int: ...
    def get_selected_drink(self) -> DrinkType: ...
    
    # Операция приготовления
    def brew(self) -> bool: ...
```

**Описание операций:**
- `power_on()` — включение машины, возвращает успех операции
- `power_off()` — выключение машины
- `select_drink(drink)` — выбор напитка, возвращает True если выбор возможен
- `cancel()` — отмена текущего приготовления
- `brew()` — запуск приготовления выбранного напитка

### 3.2. Класс Контроллер (Controller)

```python
class EventType(Enum):
    BUTTON_PRESSED = 1
    SENSOR_ALERT = 2
    TIMER_TIMEOUT = 3
    OVERHEAT = 4

class ButtonType(Enum):
    POWER = 1
    DRINK = 2
    CANCEL = 3

class Event:
    event_type: EventType
    button_type: ButtonType
    message: Any

class Controller:
    # Конструктор и деструктор
    def __init__(self): ...
    def __del__(self): ...
    
    # Операции обработки событий
    def get_event(self) -> Event: ...
    def dispatcher(self) -> None: ...  # Бесконечный цикл обработки
    
    # Операции управления устройствами
    def start_grinder(self) -> None: ...
    def stop_grinder(self) -> None: ...
    def start_heater(self) -> None: ...
    def stop_heater(self) -> None: ...
    def start_pump(self) -> None: ...
    def stop_pump(self) -> None: ...
    def start_frother(self) -> None: ...
    def stop_frother(self) -> None: ...
    
    # Операции работы с датчиками
    def check_water_level(self) -> bool: ...
    def check_beans(self) -> bool: ...
    def check_waste(self) -> bool: ...
    def check_temperature(self) -> float: ...
    def check_cup(self) -> bool: ...
    
    # Операции уведомлений
    def display_message(self, msg: str) -> None: ...
    def alert_service(self, error: str) -> None: ...
```

**Описание операций:**
- `dispatcher()` — основной цикл обработки событий
- `get_event()` — получение следующего события из очереди
- Операции `start_*/stop_*` — команды управления исполнительными устройствами
- Операции `check_*` — запросы к датчикам

### 3.3. Класс Датчик (Sensor)

```python
class SensorType(Enum):
    WATER_LEVEL = 1
    BEANS = 2
    WASTE = 3
    TEMPERATURE = 4
    OVERHEAT = 5
    CUP = 6

class Sensor:
    # Атрибуты
    sensor_type: SensorType
    value: float
    threshold: float
    
    # Конструктор
    def __init__(self, sensor_type: SensorType, threshold: float): ...
    
    # Операции
    def get_value(self) -> float: ...
    def is_threshold_exceeded(self) -> bool: ...
    def reset(self) -> None: ...
```

### 3.4. Класс Исполнительное устройство (Actuator)

```python
class ActuatorState(Enum):
    OFF = 0
    ON = 1
    ERROR = 2

class Actuator:
    # Атрибуты
    state: ActuatorState
    
    # Конструктор
    def __init__(self): ...
    
    # Операции
    def turn_on(self) -> bool: ...
    def turn_off(self) -> None: ...
    def get_state(self) -> ActuatorState: ...

class Grinder(Actuator):
    grind_time: float  # секунды
    
    def grind(self, duration: float) -> None: ...

class Pump(Actuator):
    pressure: float  # бар
    
    def set_pressure(self, pressure: float) -> None: ...
    def pour(self, duration: float) -> None: ...

class Heater(Actuator):
    temperature: float
    target_temp: float
    
    def heat_to(self, target: float) -> bool: ...
    def get_temperature(self) -> float: ...

class Frother(Actuator):
    def froth(self, duration: float) -> None: ...
```

### 3.5. Класс Дисплей (Display)

```python
class Display:
    # Атрибуты
    current_message: str
    
    # Конструктор
    def __init__(self): ...
    
    # Операции
    def show_message(self, message: str) -> None: ...
    def show_progress(self, percent: int) -> None: ...
    def show_error(self, error: str) -> None: ...
    def clear(self) -> None: ...
```

### 3.6. Класс Кнопка (Button)

```python
class Button:
    # Атрибуты
    is_lit: bool
    is_pressed: bool
    
    # Конструктор
    def __init__(self): ...
    
    # Операции
    def press(self) -> None: ...
    def release(self) -> None: ...
    def light_on(self) -> None: ...
    def light_off(self) -> None: ...
    def is_active(self) -> bool: ...

class DrinkButton(Button):
    drink_type: DrinkType
    
    def get_drink_type(self) -> DrinkType: ...

class PowerButton(Button):
    def toggle_power(self) -> None: ...

class CancelButton(Button):
    def cancel(self) -> None: ...
```

### 3.7. Класс Таймер (Timer)

```python
class Timer:
    # Атрибуты
    duration: float
    remaining: float
    is_running: bool
    callback: Callable
    
    # Конструктор
    def __init__(self): ...
    
    # Операции
    def start(self, duration: float, callback: Callable) -> None: ...
    def stop(self) -> None: ...
    def reset(self) -> None: ...
    def get_remaining(self) -> float: ...
    def is_expired(self) -> bool: ...
```

---

## 4. Выводы

В данной лабораторной работе исследовано поведение системы реального времени «Кофемашина» путём анализа состояний и действий объектов.

**Результаты работы:**

1. **Диаграмма состояний** — выделены 4 основных состояния (Выключена, Готова, Занята, Ошибка) и 6 подсостояний для состояния «Занята»

2. **Диаграммы активности** — построены для двух сценариев:
   - Приготовление эспрессо (последовательный алгоритм)
   - Приготовление капучино (с параллельным выполнением)

3. **Операции классов** — определены операции для 7 ключевых классов:
   - CoffeeMachine — 8 операций
   - Controller — 17 операций
   - Sensor — 3 операции
   - Actuator — 3 базовые + специфичные для наследников
   - Display — 4 операции
   - Button — 5 базовых + специфичные для наследников
   - Timer — 5 операций

Система демонстрирует типичные характеристики СРВ:
- **Реактивность** — реакция на события от датчиков и кнопок
- **Временные ограничения** — таймауты, время приготовления
- **Параллельность** — одновременный помол и нагрев
- **Безопасность** — контроль перегрева, проверка ресурсов
